<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Taxi Map</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Replace YOUR_GOOGLE_API_KEY with your actual Google Maps JS API key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_API_KEY"></script>
    <style>
      html, body { margin: 0; height: 100%; }
      #map { height: 100%; width: 100%; }
      #info {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 8px 12px;
        border-radius: 10px;
        font-size: 15px;
        z-index: 5;
      }
      #confirm {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #0a84ff;
        color: white;
        border: none;
        border-radius: 12px;
        padding: 10px 20px;
        font-size: 16px;
        z-index: 5;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="info">–ù–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç—É, —â–æ–± –≤–∏–±—Ä–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç: –ø–µ—Ä—à–∞ —Ç–æ—á–∫–∞ ‚Äî –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è (A), –¥—Ä—É–≥–∞ ‚Äî –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è (B)</div>
    <button id="confirm" disabled>üöï –ó–∞–º–æ–≤–∏—Ç–∏</button>

    <script>
      let map, fromMarker, toMarker, cars = [];
      let from = null, to = null;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 50.4501, lng: 30.5234 },
          zoom: 13,
        });

        map.addListener("click", (e) => {
          if (!from) {
            from = e.latLng;
            fromMarker = new google.maps.Marker({
              position: from,
              map,
              label: "A",
            });
            document.getElementById("info").textContent = "–í–∏–±—Ä–∞–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è (A). –¢–µ–ø–µ—Ä –Ω–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è (B).";
          } else if (!to) {
            to = e.latLng;
            toMarker = new google.maps.Marker({
              position: to,
              map,
              label: "B",
            });
            document.getElementById("info").textContent = "–ú–∞—Ä—à—Ä—É—Ç –≥–æ—Ç–æ–≤–∏–π ‚Äî –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–ó–∞–º–æ–≤–∏—Ç–∏¬ª";
            document.getElementById("confirm").disabled = false;
            drawRoute();
          }
        });

        spawnCars();
        animateCars();
      }

      function drawRoute() {
        if (!from || !to) return;
        const route = new google.maps.Polyline({
          path: [from, to],
          geodesic: true,
          strokeColor: "#0a84ff",
          strokeOpacity: 1.0,
          strokeWeight: 4,
        });
        route.setMap(map);
      }

      // --- –ê–≤—Ç–æ (—ñ–º—ñ—Ç–∞—Ü—ñ—è —Ä—É—Ö—É) ---
      function spawnCars() {
        for (let i = 0; i < 8; i++) {
          let car = new google.maps.Marker({
            position: {
              lat: 50.45 + Math.random() * 0.04 - 0.02,
              lng: 30.52 + Math.random() * 0.04 - 0.02,
            },
            map,
            icon: {
              url: "https://cdn-icons-png.flaticon.com/512/3097/3097019.png",
              scaledSize: new google.maps.Size(32, 32),
            },
          });
          cars.push({ marker: car, dir: Math.random() * 360 });
        }
      }

      function animateCars() {
        setInterval(() => {
          cars.forEach((c) => {
            const pos = c.marker.getPosition();
            const lat = pos.lat() + 0.00015 * Math.sin(c.dir);
            const lng = pos.lng() + 0.00015 * Math.cos(c.dir);
            c.marker.setPosition({ lat, lng });
            // slightly change direction sometimes
            if (Math.random() < 0.05) c.dir += (Math.random() - 0.5) * 1.5;
          });
        }, 800);
      }

      document.getElementById("confirm").addEventListener("click", () => {
        if (!from || !to) return;
        Telegram.WebApp.sendData(
          JSON.stringify({
            from: from.toJSON(),
            to: to.toJSON(),
          })
        );
        Telegram.WebApp.close();
      });

      window.onload = initMap;
    </script>
  </body>
</html>
