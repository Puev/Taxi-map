<!doctype html>
<html lang="uk">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Go_Trevel</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>html,body{height:100%;margin:0;font-family:system-ui}#map{height:75vh}#controls{padding:8px}button{padding:10px;border-radius:8px;border:none;background:#2b6cb0;color:#fff}</style>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head><body>
<div id="map"></div><div id="controls"><button id="locBtn">üìç –ú–æ—è –ª–æ–∫–∞—Ü—ñ—è</button><button id="callBtn">üöï –í–∏–∫–ª–∏–∫–∞—Ç–∏ —Ç–∞–∫—Å—ñ</button><span id="status">–û–±–µ—Ä—ñ—Ç—å —Ç–æ—á–∫–∏</span></div>
<script>
const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
if(tg) tg.expand();
const BACKEND = (location.hostname === 'localhost')? 'http://localhost:8000' : 'https://YOUR_BACKEND_URL';
const map = L.map('map').setView([48.62,22.28],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
let from=null, to=null, fm=null, tm=null, rl=null;
map.on('click', e=>{
  if(!from){ from=e.latlng; fm=L.marker(from).addTo(map).bindPopup('–ü–æ—á–∞—Ç–æ–∫').openPopup(); document.getElementById('status').textContent='–û–±–µ—Ä—ñ—Ç—å –∫—ñ–Ω–µ—Ü—å'; }
  else if(!to){ to=e.latlng; tm=L.marker(to).addTo(map).bindPopup('–ö—ñ–Ω–µ—Ü—å').openPopup(); rl=L.polyline([from,to],{color:'blue'}).addTo(map); document.getElementById('status').textContent='–ì–æ—Ç–æ–≤–æ'; }
  else { if(fm) map.removeLayer(fm); if(tm) map.removeLayer(tm); if(rl) map.removeLayer(rl); from=e.latlng; to=null; fm=L.marker(from).addTo(map).bindPopup('–ü–æ—á–∞—Ç–æ–∫').openPopup(); document.getElementById('status').textContent='–û–±–µ—Ä—ñ—Ç—å –∫—ñ–Ω–µ—Ü—å'; }
});
document.getElementById('locBtn').addEventListener('click', ()=>{ if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p=>{ map.setView([p.coords.latitude,p.coords.longitude],15); if(!from){ from=L.latLng(p.coords.latitude,p.coords.longitude); fm=L.marker(from).addTo(map).bindPopup('–ü–æ—á–∞—Ç–æ–∫ (–í–∞—à–∞ –ª–æ–∫–∞—Ü—ñ—è)').openPopup(); document.getElementById('status').textContent='–û–±–µ—Ä—ñ—Ç—å –∫—ñ–Ω–µ—Ü—å'; } }); });
document.getElementById('callBtn').addEventListener('click', async ()=>{
  if(!from || !to){ alert('–û–±–µ—Ä—ñ—Ç—å –¥–≤—ñ —Ç–æ—á–∫–∏'); return; }
  const payload = { from:{lat:from.lat,lng:from.lng}, to:{lat:to.lat,lng:to.lng} };
  if(tg){ try{ tg.sendData(JSON.stringify(payload)); } catch(e){ console.warn(e); } }
  try{
    const res = await fetch(BACKEND + '/orders',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(res.ok){
      const j = await res.json();
      document.getElementById('status').textContent = '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ (ID: '+j.id+'). –ß–µ–∫–∞—î–º–æ –≤–æ–¥—ñ—è...';
      const wsproto = (BACKEND.startsWith('https'))? 'wss':'ws';
      const host = (new URL(BACKEND)).host;
      const ws = new WebSocket(`${wsproto}://${host}/ws/orders/${j.id}`);
      ws.onmessage = e=>{ const m=JSON.parse(e.data); if(m.type==='driver_assigned') document.getElementById('status').textContent='–í–æ–¥—ñ–π –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π. ETA: '+m.eta+' —Ö–≤. –¶—ñ–Ω–∞: '+m.price+' –≥—Ä–Ω'; if(m.type==='driver_pos'){ if(window.driverMarker) window.driverMarker.setLatLng([m.lat,m.lng]); else window.driverMarker = L.marker([m.lat,m.lng]).addTo(map); } };
    } else { alert('–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è'); }
  } catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞'); }
});
</script></body></html>